-- [[ INVENTORY HUD v2.0 - CON BOTN ABRIR/CERRAR ]]
-- UBICACIN: StarterGui -> LocalScript (Llamar "InventoryHUD")

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- Esperar conexiones
local Remotes = ReplicatedStorage:WaitForChild("ViralRemotes")
local upgradeFunc = Remotes:WaitForChild("UpgradeInventory")
local equipEvent = Remotes:WaitForChild("EquipFromInventory")
local MarketNews = ReplicatedStorage:WaitForChild("MarketNews")

-- === 1. CREAR LA INTERFAZ (GUI) ===
local sg = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
sg.Name = "ViralHUD"
sg.ResetOnSpawn = false 

-- BOTN DE APERTURA (TOGGLE)
local toggleBtn = Instance.new("TextButton", sg)
toggleBtn.Name = "ToggleBackpack"
toggleBtn.Size = UDim2.new(0, 50, 0, 50)
toggleBtn.Position = UDim2.new(0, 10, 0.5, -20) -- Centro Izquierda (Peque帽o)
toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
toggleBtn.Text = ""
toggleBtn.TextSize = 30
local tCorner = Instance.new("UICorner", toggleBtn); tCorner.CornerRadius = UDim.new(0, 8)

-- FRAME PRINCIPAL (MOCHILA) - OCULTO POR DEFECTO
local mainFrame = Instance.new("Frame", sg)
mainFrame.Name = "BackpackFrame"
mainFrame.Size = UDim2.new(0, 220, 0, 320)
-- Posici贸n: Justo a la derecha del bot贸n toggle
mainFrame.Position = UDim2.new(0, 70, 0.5, -160) 
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
mainFrame.BorderSizePixel = 0
mainFrame.Visible = false -- 隆AHORA EMPIEZA CERRADO!
local corner = Instance.new("UICorner", mainFrame); corner.CornerRadius = UDim.new(0, 8)

-- TTULO
local title = Instance.new("TextLabel", mainFrame)
title.Size = UDim2.new(1, 0, 0, 40)
title.BackgroundTransparency = 1
title.Text = "MOCHILA"
title.Font = Enum.Font.FredokaOne
title.TextSize = 24
title.TextColor3 = Color3.new(1,1,1)

-- Bot贸n CERRAR (X) dentro del frame
local closeBtn = Instance.new("TextButton", mainFrame)
closeBtn.Size = UDim2.new(0, 30, 0, 30)
closeBtn.Position = UDim2.new(1, -35, 0, 5)
closeBtn.BackgroundTransparency = 1
closeBtn.Text = "X"
closeBtn.TextColor3 = Color3.new(1, 0, 0)
closeBtn.Font = Enum.Font.FredokaOne
closeBtn.TextSize = 20

-- LISTA DE ITEMS (SCROLL)
local itemsFrame = Instance.new("ScrollingFrame", mainFrame)
itemsFrame.Size = UDim2.new(1, -20, 1, -100)
itemsFrame.Position = UDim2.new(0, 10, 0, 40)
itemsFrame.BackgroundTransparency = 1
itemsFrame.ScrollBarThickness = 4
local layout = Instance.new("UIListLayout", itemsFrame); layout.Padding = UDim.new(0, 5)

-- BOTN DE MEJORA
local upBtn = Instance.new("TextButton", mainFrame)
upBtn.Size = UDim2.new(1, -20, 0, 45)
upBtn.Position = UDim2.new(0, 10, 1, -55)
upBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
upBtn.Font = Enum.Font.FredokaOne
upBtn.TextSize = 16
upBtn.TextColor3 = Color3.new(1,1,1)
local btnCorner = Instance.new("UICorner", upBtn); btnCorner.CornerRadius = UDim.new(0, 6)

-- NEWS TICKER (NOTICIAS DE MERCADO - ARRIBA)
local newsBg = Instance.new("Frame", sg)
newsBg.Size = UDim2.new(0, 300, 0, 30)
newsBg.Position = UDim2.new(0.5, -150, 0, 10) -- Arriba Centro
newsBg.BackgroundColor3 = Color3.new(0,0,0)
newsBg.BackgroundTransparency = 0.5
local newsCorner = Instance.new("UICorner", newsBg); newsCorner.CornerRadius = UDim.new(1,0)

local newsLabel = Instance.new("TextLabel", newsBg)
newsLabel.Size = UDim2.new(1,0,1,0)
newsLabel.BackgroundTransparency = 1
newsLabel.Text = "Cargando Mercado..."
newsLabel.TextColor3 = Color3.new(1,1,0)
newsLabel.Font = Enum.Font.Code
newsLabel.TextSize = 16

-- === 2. LGICA VISUAL ===

-- Funci贸n Toggle (Abrir/Cerrar)
local function ToggleInventory()
	mainFrame.Visible = not mainFrame.Visible
	if mainFrame.Visible then
		toggleBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100) -- Oscuro si est谩 abierto
	else
		toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255) -- Azul si est谩 cerrado
	end
end

toggleBtn.MouseButton1Click:Connect(ToggleInventory)
closeBtn.MouseButton1Click:Connect(ToggleInventory)

local function updateInventory()
	-- Solo actualizamos si est谩 visible para ahorrar recursos
	if not mainFrame.Visible then return end

	-- 1. Limpiar lista visual anterior
	for _, c in ipairs(itemsFrame:GetChildren()) do
		if c:IsA("TextButton") then c:Destroy() end
	end
	
	-- 2. Leer inventario real del jugador
	local inv = player:FindFirstChild("Inventory")
	local maxSlots = player:GetAttribute("MaxSlots") or 4
	local currentCount = 0
	
	if inv then
		local items = inv:GetChildren()
		currentCount = #items
		
		-- Crear un bot贸n por cada item
		for i, item in ipairs(items) do
			local itemBtn = Instance.new("TextButton", itemsFrame)
			itemBtn.Size = UDim2.new(1, 0, 0, 30)
			itemBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
			itemBtn.Text = "  " .. item.Name
			itemBtn.TextColor3 = Color3.new(1,1,1)
			itemBtn.Font = Enum.Font.SourceSansBold
			itemBtn.TextSize = 14
			itemBtn.TextXAlignment = Enum.TextXAlignment.Left
			local ic = Instance.new("UICorner", itemBtn); ic.CornerRadius = UDim.new(0,4)
			
			-- Al hacer clic en un item, pedir equiparlo
			itemBtn.MouseButton1Click:Connect(function()
				equipEvent:FireServer() 
			end)
		end
	end
	
	-- 3. Actualizar textos
	title.Text = "MOCHILA (" .. currentCount .. "/" .. maxSlots .. ")"
	
	-- L贸gica visual del bot贸n de mejora (H铆brido)
	if maxSlots < 16 then
		local cost = 1000 * (maxSlots ^ 2)
		upBtn.Text = "MEJORAR (+".. 4 ..")\n$" .. cost
		upBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 100) -- Verde Dinero
	elseif maxSlots < 32 then
		upBtn.Text = "EXPANDIR (ROBUX)\n"
		upBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255) -- Azul Robux
	else
		upBtn.Text = "MXIMO ALCANZADO"
		upBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
		upBtn.Active = false
	end
end

-- === 3. CONEXIONES ===

-- Actualizar inventario constantemente
RunService.RenderStepped:Connect(function()
	if player:FindFirstChild("Inventory") then
		updateInventory()
	end
end)

-- Bot贸n de Mejorar
upBtn.MouseButton1Click:Connect(function()
	local success, msg = upgradeFunc:InvokeServer()
	print(msg) 
end)

-- Escuchar noticias del mercado
MarketNews.Changed:Connect(function(newVal)
	newsLabel.Text = newVal
	if string.find(newVal, "STONKS") then -- Detectar tu palabra clave
		if string.find(newVal, "猬锔") then
			newsLabel.TextColor3 = Color3.fromRGB(0, 255, 100) -- Verde
		else
			newsLabel.TextColor3 = Color3.fromRGB(255, 50, 50) -- Rojo
		end
	else
		newsLabel.TextColor3 = Color3.fromRGB(255, 255, 100)
	end
end)

-- Inicializar
newsLabel.Text = MarketNews.Value

-- [[ INVENTORY HUD v3.0 - CON TIMERS Y TOGGLE ]]
-- UBICACI√ìN: StarterGui -> LocalScript (Llamar "InventoryHUD")

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- Esperar conexiones
local Remotes = ReplicatedStorage:WaitForChild("ViralRemotes")
local upgradeFunc = Remotes:WaitForChild("UpgradeInventory")
local equipEvent = Remotes:WaitForChild("EquipFromInventory")
local storeInBackpackEvent = Remotes:WaitForChild("StoreInBackpack")
local unstuckEvent = Remotes:WaitForChild("Unstuck")
local MarketNews = ReplicatedStorage:WaitForChild("MarketNews")

local BASE_RADIUS = 180 -- Solo mostrar DESATASCAR dentro de este radio de tu base

-- === 1. CREAR LA INTERFAZ (GUI) ===
local sg = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
sg.Name = "ViralHUD"
sg.ResetOnSpawn = false 

-- BOT√ìN DE APERTURA (TOGGLE)
local toggleBtn = Instance.new("TextButton", sg)
toggleBtn.Name = "ToggleBackpack"
toggleBtn.Size = UDim2.new(0, 50, 0, 50)
toggleBtn.Position = UDim2.new(0, 10, 0.5, -20)
toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
toggleBtn.Text = "üéí"
toggleBtn.TextSize = 30
local tCorner = Instance.new("UICorner", toggleBtn); tCorner.CornerRadius = UDim.new(0, 8)

-- FRAME PRINCIPAL (MOCHILA)
local mainFrame = Instance.new("Frame", sg)
mainFrame.Name = "BackpackFrame"
mainFrame.Size = UDim2.new(0, 260, 0, 380)
mainFrame.Position = UDim2.new(0, 70, 0.5, -190) 
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
mainFrame.BorderSizePixel = 0
mainFrame.Visible = false
local corner = Instance.new("UICorner", mainFrame); corner.CornerRadius = UDim.new(0, 8)

-- T√çTULO
local title = Instance.new("TextLabel", mainFrame)
title.Size = UDim2.new(1, 0, 0, 36)
title.BackgroundTransparency = 1
title.Text = "MOCHILA"
title.Font = Enum.Font.FredokaOne
title.TextSize = 22
title.TextColor3 = Color3.new(1,1,1)

local closeBtn = Instance.new("TextButton", mainFrame)
closeBtn.Size = UDim2.new(0, 28, 0, 28)
closeBtn.Position = UDim2.new(1, -32, 0, 4)
closeBtn.BackgroundTransparency = 1
closeBtn.Text = "X"
closeBtn.TextColor3 = Color3.new(1, 0, 0)
closeBtn.Font = Enum.Font.FredokaOne
closeBtn.TextSize = 18

-- Slots (cuadrados con nombre y $/s)
local itemsFrame = Instance.new("ScrollingFrame", mainFrame)
itemsFrame.Size = UDim2.new(1, -16, 1, -155)
itemsFrame.Position = UDim2.new(0, 8, 0, 38)
itemsFrame.BackgroundTransparency = 1
itemsFrame.ScrollBarThickness = 4
local layout = Instance.new("UIListLayout", itemsFrame)
layout.Padding = UDim.new(0, 6)

-- Bot√≥n GUARDAR EN MOCHILA (cubo de la mano -> mochila)
local storeBtn = Instance.new("TextButton", mainFrame)
storeBtn.Name = "StoreInBackpackBtn"
storeBtn.Size = UDim2.new(1, -16, 0, 42)
storeBtn.Position = UDim2.new(0, 8, 1, -108)
storeBtn.BackgroundColor3 = Color3.fromRGB(80, 120, 80)
storeBtn.Text = "üì• GUARDAR EN MOCHILA"
storeBtn.Font = Enum.Font.FredokaOne
storeBtn.TextSize = 16
storeBtn.TextColor3 = Color3.new(1,1,1)
local storeCorner = Instance.new("UICorner", storeBtn); storeCorner.CornerRadius = UDim.new(0, 6)

local upBtn = Instance.new("TextButton", mainFrame)
upBtn.Size = UDim2.new(1, -16, 0, 42)
upBtn.Position = UDim2.new(0, 8, 1, -52)
upBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
upBtn.Font = Enum.Font.FredokaOne
upBtn.TextSize = 14
upBtn.TextColor3 = Color3.new(1,1,1)
local btnCorner = Instance.new("UICorner", upBtn); btnCorner.CornerRadius = UDim.new(0, 6)

-- NEWS TICKER (ARRIBA CENTRO)
local newsBg = Instance.new("Frame", sg)
newsBg.Size = UDim2.new(0, 300, 0, 30)
newsBg.Position = UDim2.new(0.5, -150, 0, 10)
newsBg.BackgroundColor3 = Color3.new(0,0,0)
newsBg.BackgroundTransparency = 0.5
local newsCorner = Instance.new("UICorner", newsBg); newsCorner.CornerRadius = UDim.new(1,0)

local newsLabel = Instance.new("TextLabel", newsBg)
newsLabel.Size = UDim2.new(1,0,1,0)
newsLabel.BackgroundTransparency = 1
newsLabel.Text = "Cargando Mercado..."
newsLabel.TextColor3 = Color3.new(1,1,0)
newsLabel.Font = Enum.Font.Code
newsLabel.TextSize = 16

-- [[ NUEVO: PANEL DE TIMERS (ARRIBA DERECHA DEL TICKER) ]]
local timerFrame = Instance.new("Frame", sg)
timerFrame.Size = UDim2.new(0, 120, 0, 60)
timerFrame.Position = UDim2.new(0.5, 160, 0, 10) -- A la derecha de las noticias
timerFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
timerFrame.BackgroundTransparency = 0.3
local tCorner = Instance.new("UICorner", timerFrame); tCorner.CornerRadius = UDim.new(0, 6)

local eventTimerLbl = Instance.new("TextLabel", timerFrame)
eventTimerLbl.Size = UDim2.new(1, -10, 0, 25)
eventTimerLbl.Position = UDim2.new(0, 5, 0, 5)
eventTimerLbl.BackgroundTransparency = 1
eventTimerLbl.TextXAlignment = Enum.TextXAlignment.Left
eventTimerLbl.Font = Enum.Font.FredokaOne
eventTimerLbl.TextColor3 = Color3.fromRGB(255, 100, 100)
eventTimerLbl.TextSize = 14
eventTimerLbl.Text = "EVENTO: --:--"

local spinTimerLbl = Instance.new("TextLabel", timerFrame)
spinTimerLbl.Size = UDim2.new(1, -10, 0, 25)
spinTimerLbl.Position = UDim2.new(0, 5, 0, 30)
spinTimerLbl.BackgroundTransparency = 1
spinTimerLbl.TextXAlignment = Enum.TextXAlignment.Left
spinTimerLbl.Font = Enum.Font.FredokaOne
spinTimerLbl.TextColor3 = Color3.fromRGB(100, 255, 100)
spinTimerLbl.TextSize = 14
spinTimerLbl.Text = "RULETA: LISTA"

-- Bot√≥n DESATASCAR (abajo derecha)
local unstuckBtn = Instance.new("TextButton", sg)
unstuckBtn.Size = UDim2.new(0, 120, 0, 40)
unstuckBtn.Position = UDim2.new(1, -130, 1, -50)
unstuckBtn.AnchorPoint = Vector2.new(0, 0)
unstuckBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
unstuckBtn.Text = "DESATASCAR"
unstuckBtn.Font = Enum.Font.FredokaOne
unstuckBtn.TextSize = 16
unstuckBtn.TextColor3 = Color3.new(1,1,1)
local ubCorner = Instance.new("UICorner", unstuckBtn); ubCorner.CornerRadius = UDim.new(0, 8)

-- === 2. L√ìGICA VISUAL ===

local function ToggleInventory()
	mainFrame.Visible = not mainFrame.Visible
	if mainFrame.Visible then
		toggleBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
	else
		toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
	end
end
toggleBtn.MouseButton1Click:Connect(ToggleInventory)
closeBtn.MouseButton1Click:Connect(ToggleInventory)

local function updateInventory()
	if not mainFrame.Visible then return end
	for _, c in ipairs(itemsFrame:GetChildren()) do c:Destroy() end

	local inv = player:FindFirstChild("Inventory")
	local maxSlots = player:GetAttribute("MaxSlots") or 4
	local items = inv and inv:GetChildren() or {}
	local currentCount = #items

	-- Un slot por cada espacio (vac√≠o o con cubo)
	for i = 1, maxSlots do
		local slotFrame = Instance.new("TextButton", itemsFrame)
		slotFrame.Size = UDim2.new(1, 0, 0, 52)
		slotFrame.Text = ""
		slotFrame.TextXAlignment = Enum.TextXAlignment.Left
		slotFrame.TextYAlignment = Enum.TextYAlignment.Top
		slotFrame.AutoButtonColor = true
		local slotCorner = Instance.new("UICorner", slotFrame); slotCorner.CornerRadius = UDim.new(0, 6)

		local nameLbl = Instance.new("TextLabel", slotFrame)
		nameLbl.Size = UDim2.new(1, -12, 0, 22)
		nameLbl.Position = UDim2.new(0, 8, 0, 4)
		nameLbl.BackgroundTransparency = 1
		nameLbl.Font = Enum.Font.FredokaOne
		nameLbl.TextSize = 16
		nameLbl.TextXAlignment = Enum.TextXAlignment.Left
		nameLbl.TextTruncate = Enum.TextTruncate.AtEnd

		local valueLbl = Instance.new("TextLabel", slotFrame)
		valueLbl.Size = UDim2.new(1, -12, 0, 18)
		valueLbl.Position = UDim2.new(0, 8, 0, 28)
		valueLbl.BackgroundTransparency = 1
		valueLbl.Font = Enum.Font.Code
		valueLbl.TextSize = 14
		valueLbl.TextXAlignment = Enum.TextXAlignment.Left

		local item = items[i]
		local slotIndex = i
		if item and item:IsA("BasePart") then
			local val = item:GetAttribute("Value") or 0
			slotFrame.BackgroundColor3 = Color3.fromRGB(50, 55, 70)
			nameLbl.Text = item.Name
			nameLbl.TextColor3 = Color3.new(1, 1, 1)
			valueLbl.Text = (val >= 0 and "+" or "") .. "$" .. val .. "/s"
			valueLbl.TextColor3 = val >= 0 and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(255, 100, 100)
			slotFrame.MouseButton1Click:Connect(function() equipEvent:FireServer(slotIndex) end)
		else
			slotFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
			nameLbl.Text = "Vac√≠o"
			nameLbl.TextColor3 = Color3.fromRGB(120, 120, 120)
			valueLbl.Text = "‚Äî"
			valueLbl.TextColor3 = Color3.fromRGB(100, 100, 100)
			slotFrame.Active = false
		end
	end

	-- Bot√≥n guardar: solo activo si llevas cubo
	local carrying = player:GetAttribute("Carrying")
	storeBtn.Visible = true
	storeBtn.Active = carrying
	storeBtn.BackgroundColor3 = carrying and Color3.fromRGB(80, 160, 80) or Color3.fromRGB(60, 60, 60)
	storeBtn.TextColor3 = carrying and Color3.new(1,1,1) or Color3.fromRGB(120, 120, 120)

	title.Text = "MOCHILA (" .. currentCount .. "/" .. maxSlots .. ")"

	if maxSlots < 16 then
		local cost = 1000 * (maxSlots ^ 2)
		upBtn.Text = "MEJORAR (+".. 4 ..")\n$" .. cost; upBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 100)
	elseif maxSlots < 32 then
		upBtn.Text = "EXPANDIR (ROBUX)\nüíé"; upBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
	else
		upBtn.Text = "M√ÅXIMO ALCANZADO"; upBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80); upBtn.Active = false
	end
end

storeBtn.MouseButton1Click:Connect(function()
	if player:GetAttribute("Carrying") then storeInBackpackEvent:FireServer() end
end)

-- FUNCI√ìN HELPER: Formato MM:SS
local function FormatTime(seconds)
	if seconds <= 0 then return "00:00" end
	local m = math.floor(seconds / 60)
	local s = seconds % 60
	return string.format("%02d:%02d", m, s)
end

-- UPDATE DE TIMERS (Cada Frame)
RunService.RenderStepped:Connect(function()
	-- 0. Bot√≥n DESATASCAR: solo visible en mi base
	do
		local char = player.Character
		local hrp = char and char:FindFirstChild("HumanoidRootPart")
		local towers = workspace:FindFirstChild("Towers")
		local tycoon = towers and towers:FindFirstChild("Tycoon_" .. player.UserId)
		local origin = tycoon and tycoon:FindFirstChild("GridParts") and tycoon.GridParts:FindFirstChild("Origin")
		if hrp and origin and typeof(origin.Position) == "Vector3" then
			local dist = (hrp.Position - origin.Position).Magnitude
			local radius = type(BASE_RADIUS) == "number" and BASE_RADIUS or 180
			unstuckBtn.Visible = (type(dist) == "number") and (dist <= radius)
		else
			unstuckBtn.Visible = false
		end
	end

	-- 1. Actualizar Inventario si est√° abierto
	if player:FindFirstChild("Inventory") then updateInventory() end

	local now = os.time()

	-- 2. Timer Evento (Global)
	local nextEvent = ReplicatedStorage:GetAttribute("NextEventTime") or 0
	local timeLeftEvent = math.max(0, nextEvent - now)
	if timeLeftEvent > 0 then
		eventTimerLbl.Text = "EVENTO: " .. FormatTime(timeLeftEvent)
		eventTimerLbl.TextColor3 = Color3.fromRGB(255, 200, 100)
	else
		eventTimerLbl.Text = "EVENTO: ¬°AHORA!"
		eventTimerLbl.TextColor3 = Color3.fromRGB(255, 0, 0)
		-- Efecto de parpadeo simple
		if math.floor(tick()*2)%2 == 0 then eventTimerLbl.TextColor3 = Color3.new(1,1,1) end
	end

	-- 3. Timer Ruleta (Personal)
	local nextSpin = player:GetAttribute("NextSpinTime") or 0
	local timeLeftSpin = math.max(0, nextSpin - now)
	if timeLeftSpin > 0 then
		spinTimerLbl.Text = "RULETA: " .. FormatTime(timeLeftSpin)
		spinTimerLbl.TextColor3 = Color3.fromRGB(150, 150, 150)
	else
		spinTimerLbl.Text = "RULETA: ¬°LISTA!"
		spinTimerLbl.TextColor3 = Color3.fromRGB(0, 255, 100)
	end
end)

-- Bot√≥n Mejorar
upBtn.MouseButton1Click:Connect(function() local s,m=upgradeFunc:InvokeServer(); print(m) end)

-- Noticias Mercado
MarketNews.Changed:Connect(function(newVal)
	newsLabel.Text = newVal
	if string.find(newVal, "STONKS") then
		if string.find(newVal, "‚¨ÜÔ∏è") then newsLabel.TextColor3 = Color3.fromRGB(0, 255, 100)
		else newsLabel.TextColor3 = Color3.fromRGB(255, 50, 50) end
	else newsLabel.TextColor3 = Color3.fromRGB(255, 255, 100) end
end)
newsLabel.Text = MarketNews.Value

-- DESATASCAR: oculto por defecto hasta que est√©s en base
unstuckBtn.Visible = false

unstuckBtn.MouseButton1Click:Connect(function()
	unstuckEvent:FireServer()
end)

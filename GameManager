-- [[ VIRAL TYCOON - GAME MANAGER v33.0 (FULL CHAOS INTEGRADO) ]]
-- UBICACIÓN: ServerScriptService -> Script

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Debris = game:GetService("Debris")
local ServerScriptService = game:GetService("ServerScriptService")

-- === IMPORTAR CONFIGURACIÓN ===
-- Asegúrate de que el ModuleScript se llame exactamente "GameConfig"
local ConfigModule = ServerScriptService:WaitForChild("GameConfig")
local Config = require(ConfigModule)

local SETTINGS = Config.SETTINGS
local CUBE_TYPES = Config.CUBES

-- Variables Globales
local plots = {}
local towersFolder = workspace:FindFirstChild("Towers") or Instance.new("Folder", workspace)
towersFolder.Name = "Towers"
local globalCubes = workspace:FindFirstChild("GlobalCubes") or Instance.new("Folder", workspace)
globalCubes.Name = "GlobalCubes"

-- === SETUP RED (REMOTES) ===
local Remotes = ReplicatedStorage:FindFirstChild("ViralRemotes") or Instance.new("Folder", ReplicatedStorage)
Remotes.Name = "ViralRemotes"
local placeEvent = Remotes:FindFirstChild("PlaceCube") or Instance.new("RemoteEvent", Remotes)
placeEvent.Name = "PlaceCube"
local eventMessage = Remotes:FindFirstChild("EventMessage") or Instance.new("RemoteEvent", Remotes)
eventMessage.Name = "EventMessage"

-- === FUNCIONES AUXILIARES ===

function PickupCube(player, cube, val)
	if player:GetAttribute("Carrying") then return end
	player:SetAttribute("Carrying", true)
	player:SetAttribute("CarryingValue", val)

	cube.CanCollide = false
	cube.Anchored = false
	cube.Parent = player.Character
	local w = Instance.new("WeldConstraint", cube)
	w.Name = "CarryingWeld"
	w.Part0 = player.Character.HumanoidRootPart
	w.Part1 = cube
	cube.CFrame = player.Character.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5) 
end

function CreateStealPrompt(cube)
	if cube:FindFirstChild("StealPrompt") then return end

	local price = cube:GetAttribute("Price") or 100
	local originalOwnerId = cube:GetAttribute("Owner")

	local p = Instance.new("ProximityPrompt", cube)
	p.Name = "StealPrompt"
	p.ActionText = "ROBAR/RECUPERAR" 
	p.HoldDuration = 1

	p.Triggered:Connect(function(interactor)
		local cost = price * 3
		local isMyCube = (interactor.UserId == originalOwnerId)

		-- Si es TU cubo, es GRATIS recuperarlo
		if isMyCube then cost = 0 end

		if interactor.leaderstats.Cash.Value >= cost then
			interactor.leaderstats.Cash.Value -= cost
			p:Destroy() 

			for _, w in ipairs(cube:GetChildren()) do if w:IsA("WeldConstraint") then w:Destroy() end end
			cube.Anchored = false

			if isMyCube then
				print(interactor.Name .. " recuperó su cubo.")
			end

			PickupCube(interactor, cube, cube:GetAttribute("Value"))
		end
	end)
end

function SpawnCube(customData)
	if #globalCubes:GetChildren() >= 80 then return end
	local data = customData or CUBE_TYPES[math.random(1, #CUBE_TYPES)]

	local cube = Instance.new("Part")
	cube.Name = data.Name
	cube.Size = Vector3.new(4,4,4)

	-- LÓGICA JABÓN
	if data.Name == "Jabón" then 
		cube.Shape = Enum.PartType.Ball 
		cube.CustomPhysicalProperties = PhysicalProperties.new(0.7, 0, 0.5, 100, 1) 
	end

	cube.Position = Vector3.new(math.random(-60, 60), 120, math.random(-60, 60))
	cube.Material, cube.Color = data.Mat, data.Color
	cube:SetAttribute("Owner", 0); cube:SetAttribute("Value", data.Value); cube:SetAttribute("Price", data.Price)

	-- [[ NUEVO: PERMABLOCK ]]
	if data.Name == "Permablock" then cube:SetAttribute("IsPerma", true) end

	-- [[ NUEVO: GLITCH ]]
	if data.Name == "Glitch" then
		task.spawn(function()
			while cube and cube.Parent do
				local newVal = math.random(-100, 500)
				cube:SetAttribute("Value", newVal)
				task.wait(10)
			end
		end)
	end

	-- LÓGICA ANTIMATERIA
	if data.Name == "Antimateria" then
		cube.Touched:Connect(function(hit)
			if hit:IsA("BasePart") and hit ~= cube then
				if hit:GetAttribute("IsPerma") then return end -- Inmune

				local isOtherCube = hit:GetAttribute("Value") ~= nil or (hit.Parent and (hit.Parent.Name == "Blocks" or hit.Parent.Name == "GlobalCubes"))
				if isOtherCube then
					local exp = Instance.new("Explosion"); exp.Position = cube.Position; exp.BlastRadius = 6; exp.BlastPressure = 5000; exp.Parent = workspace
					hit:Destroy(); cube:Destroy()
				end
			end
		end)
	end

	-- ETIQUETAS VISUALES
	local function makeTxt(face, txt, color)
		local sg = Instance.new("SurfaceGui", cube); sg.Face = face
		local t = Instance.new("TextLabel", sg); t.Size = UDim2.new(1,0,1,0); t.Text = txt; t.TextScaled = true; t.TextColor3 = color; t.BackgroundTransparency = 1; t.Font = Enum.Font.FredokaOne
		return t
	end
	makeTxt(Enum.NormalId.Front, data.Rarity.."\n"..data.Name, Color3.new(1,1,1))

	-- Valor Dinámico (Glitch)
	local valLabel = makeTxt(Enum.NormalId.Top, "", Color3.new(0,1,0))
	task.spawn(function()
		while cube and cube.Parent do
			local currentVal = cube:GetAttribute("Value") or 0
			valLabel.Text = (currentVal >= 0 and "+$" or "$")..currentVal.."/s"
			valLabel.TextColor3 = currentVal >= 0 and Color3.new(0,1,0) or Color3.new(1,0,0)
			task.wait(1)
		end
	end)

	local timerLabel = makeTxt(Enum.NormalId.Right, SETTINGS.CUBE_LIFETIME.."s", Color3.new(1,1,0))

	-- TIMER DE VIDA Y NOMBRE DEL DUEÑO
	task.spawn(function()
		task.wait(0.2)
		for i = SETTINGS.CUBE_LIFETIME, 0, -1 do
			if not cube or not cube.Parent or (cube:GetAttribute("Owner") or 0) ~= 0 then 
				if timerLabel and timerLabel.Parent then 
					local ownerId = cube:GetAttribute("Owner")
					local ownerName = "ADQUIRIDO"
					local p = Players:GetPlayerByUserId(ownerId)
					if p then ownerName = p.Name end

					timerLabel.Text = ownerName
					timerLabel.TextColor3 = Color3.new(0,1,0)
				end
				return 
			end
			timerLabel.Text = i .. "s"; task.wait(1)
		end
		if cube and cube.Parent and (cube:GetAttribute("Owner") or 0) == 0 then cube:Destroy() end
	end)

	-- PROMPT DE COMPRA
	local prompt = Instance.new("ProximityPrompt", cube); prompt.HoldDuration = 0.1
	prompt.ActionText = data.Price > 0 and ("COMPRAR $"..data.Price) or "RECOGER"; cube.Parent = globalCubes
	prompt.Triggered:Connect(function(player)
		if player:GetAttribute("Carrying") then return end
		local owner = cube:GetAttribute("Owner") or 0
		local cost = (owner == 0) and data.Price or (owner == player.UserId and 0 or (data.Price == 0 and 200 or data.Price * 6))

		if owner == player.UserId then cost = 0 end -- Gratis si es tuyo

		if player.leaderstats.Cash.Value >= cost then
			player.leaderstats.Cash.Value -= cost
			cube:SetAttribute("Owner", player.UserId)
			PickupCube(player, cube, data.Value)
			prompt.Enabled = false
		end
	end)
	return cube
end

-- === LÓGICA DE SOLTAR (Física Real + Robo) ===
placeEvent.OnServerEvent:Connect(function(player, hitPos)
	local char = player.Character
	if not char then return end

	local carriedCube = nil
	for _, child in ipairs(char:GetChildren()) do 
		if child:IsA("Part") and child:FindFirstChild("CarryingWeld") then carriedCube = child; break end 
	end
	if not carriedCube then player:SetAttribute("Carrying", false); return end

	local weld = carriedCube:FindFirstChild("CarryingWeld"); if weld then weld:Destroy() end
	player:SetAttribute("Carrying", false)
	carriedCube.CanCollide = true
	carriedCube.Anchored = false
	carriedCube.AssemblyLinearVelocity = Vector3.new(0,0,0) 

	local targetPlot = nil
	for _, plotModel in ipairs(towersFolder:GetChildren()) do
		local originPart = plotModel:FindFirstChild("GridParts") and plotModel.GridParts:FindFirstChild("Origin")
		if originPart then
			local dist = (Vector2.new(hitPos.X, hitPos.Z) - Vector2.new(originPart.Position.X, originPart.Position.Z)).Magnitude
			if dist < 160 then targetPlot = plotModel; break end
		end
	end

	if targetPlot then
		local origin = targetPlot.GridParts.Origin.Position
		local gx, gz = math.round((hitPos.X-origin.X)/4)*4 + origin.X, math.round((hitPos.Z-origin.Z)/4)*4 + origin.Z

		local rayParams = RaycastParams.new()
		rayParams.FilterDescendantsInstances = {char, carriedCube}
		rayParams.FilterType = Enum.RaycastFilterType.Exclude
		local ray = workspace:Raycast(Vector3.new(gx, 500, gz), Vector3.new(0, -500, 0), rayParams)

		if ray then 
			carriedCube.Position = Vector3.new(gx, ray.Position.Y + 2.1, gz) 
			local blks = targetPlot:FindFirstChild("Blocks") or Instance.new("Folder", targetPlot)
			blks.Name = "Blocks"
			carriedCube.Parent = blks

			if ray.Instance.Name == "Origin" then
				carriedCube.Anchored = true
			else
				carriedCube.Anchored = false
				local newWeld = Instance.new("WeldConstraint")
				newWeld.Part0 = ray.Instance
				newWeld.Part1 = carriedCube
				newWeld.Parent = carriedCube
				carriedCube.Massless = true 
			end

			local plotOwnerID = targetPlot:GetAttribute("OwnerID")
			if plotOwnerID and plotOwnerID ~= player.UserId then 
				CreateStealPrompt(carriedCube) 
			end
		else 
			carriedCube.Position = Vector3.new(gx, 4, gz) 
			carriedCube.Parent = globalCubes 
			carriedCube.Anchored = false
		end
	else
		carriedCube.CFrame = char.HumanoidRootPart.CFrame * CFrame.new(0, 0, -8)
		carriedCube.Parent = globalCubes
	end
	if carriedCube:FindFirstChild("ProximityPrompt") then carriedCube.ProximityPrompt.Enabled = true end
end)

-- === GENERACIÓN DE BASES ===
function SetupPlots()
	local angleStep = (math.pi * 2) / SETTINGS.MAX_PLAYERS
	for i = 1, SETTINGS.MAX_PLAYERS do
		local angle = (i-1) * angleStep
		local x, z = math.sin(angle) * SETTINGS.CENTER_DIST, math.cos(angle) * SETTINGS.CENTER_DIST
		local pos = Vector3.new(x, 1, z)

		local m = Instance.new("Model", towersFolder); m.Name = "Plot_"..i
		local gp = Instance.new("Folder", m); gp.Name = "GridParts"
		local base = Instance.new("Part", gp); base.Name = "Origin"; base.Size = Vector3.new(32,1,32); base.Position = pos; base.Anchored = true; base.Color = Color3.fromRGB(20,20,20); base.Material = Enum.Material.DiamondPlate
		base.CFrame = CFrame.lookAt(pos, Vector3.new(0, 1, 0))
		m:SetAttribute("OwnerID", 0); m:SetAttribute("Expansions", 0)

		local board = Instance.new("Part", m); board.Size = Vector3.new(18,12,1); board.Anchored = true; board.Name = "Board"; board.Color = Color3.new(0,0,0)
		local btn = Instance.new("Part", m); btn.Name = "ExpandButton"; btn.Size = Vector3.new(8, 1, 8); btn.Anchored = true; btn.Color = Color3.fromRGB(0, 150, 255); btn.Material = Enum.Material.Neon
		local rec = Instance.new("Part", m); rec.Name = "Recycler"; rec.Size = Vector3.new(12, 0.5, 12); rec.Anchored = true; rec.Color = Color3.fromRGB(255, 0, 0); rec.Material = Enum.Material.Neon

		local function updateAssets()
			board.CFrame = base.CFrame * CFrame.new(0, 10, (base.Size.Z/2) + 8)
			btn.CFrame = base.CFrame * CFrame.new(0, 0, (base.Size.Z/2) + 16)
			rec.CFrame = base.CFrame * CFrame.new(-(base.Size.X/2 + 10), 0, 0)
		end
		updateAssets()

		local bp = Instance.new("ProximityPrompt", btn); bp.ActionText = "EXPANDIR ($"..SETTINGS.BASE_EXPAND_COST..")"; bp.HoldDuration = 1
		bp.Triggered:Connect(function(plr)
			local count = m:GetAttribute("Expansions")
			if plr.UserId == m:GetAttribute("OwnerID") and count < SETTINGS.MAX_EXPANSIONS and plr.leaderstats.Cash.Value >= SETTINGS.BASE_EXPAND_COST then
				plr.leaderstats.Cash.Value -= SETTINGS.BASE_EXPAND_COST
				m:SetAttribute("Expansions", count + 1); base.Size += Vector3.new(12, 0, 12); updateAssets()
				if count + 1 >= SETTINGS.MAX_EXPANSIONS then bp.Enabled = false; btn.Transparency = 0.5 end
			end
		end)

		local rp = Instance.new("ProximityPrompt", rec); rp.HoldDuration = 0.2
		rp.Triggered:Connect(function(plr)
			if plr.UserId == m:GetAttribute("OwnerID") then
				local cube = nil
				for _, c in ipairs(plr.Character:GetChildren()) do if c:IsA("Part") and c:FindFirstChild("CarryingWeld") then cube = c; break end end
				if cube then
					-- No reciclar Permablock
					if cube:GetAttribute("IsPerma") then return end

					local val = cube:GetAttribute("Value") or 0
					plr.leaderstats.Cash.Value += math.max(0, math.floor(val * 30)); cube:Destroy(); plr:SetAttribute("Carrying", false)
				end
			end
		end)

		for _, f in ipairs({Enum.NormalId.Front, Enum.NormalId.Back}) do
			local sg = Instance.new("SurfaceGui", board); sg.Face = f
			local t = Instance.new("TextLabel", sg); t.Size = UDim2.new(1,0,1,0); t.Text = "DISPONIBLE"; t.TextScaled = true; t.TextColor3 = Color3.new(1,1,1); t.BackgroundTransparency = 1; t.Font = Enum.Font.FredokaOne
		end
		plots[i] = {Model = m, Owner = nil}
	end
end

-- === BUCLE PRINCIPAL ===
task.spawn(function()
	while true do
		task.wait(SETTINGS.PAY_INTERVAL)
		for _, p in ipairs(Players:GetPlayers()) do
			local t = towersFolder:FindFirstChild("Tycoon_"..p.UserId)
			if t then
				local inc, maxH = 0, 0; local origin = t.GridParts.Origin.Position
				local blks = t:FindFirstChild("Blocks") or Instance.new("Folder", t); blks.Name = "Blocks"

				for _, b in ipairs(blks:GetChildren()) do
					if (Vector2.new(b.Position.X, b.Position.Z) - Vector2.new(origin.X, origin.Z)).Magnitude < 240 then
						inc += (b:GetAttribute("Value") or 0)
						local h = b.Position.Y - origin.Y
						if h > maxH then maxH = h end
					else 
						b.Parent = globalCubes; b.Anchored = false
					end
				end

				local mult = 1 + (math.floor(maxH/4)*0.5)
				local totalTick = inc * mult
				p.leaderstats.Cash.Value = math.max(0, p.leaderstats.Cash.Value + totalTick)
				p:SetAttribute("MaxH", maxH); p:SetAttribute("Time", (p:GetAttribute("Time") or 0) + 1)

				for _, sg in ipairs(t.Board:GetChildren()) do 
					if sg:IsA("SurfaceGui") then sg.TextLabel.Text = string.format("%s\n$%.1f/s\n%dft (x%.1f)", p.Name, inc*mult, maxH, mult) end 
				end
			end
		end
	end
end)

-- === MANAGER DE EVENTOS ===
task.spawn(function()
	local chaosTimer = 0
	local celestialTimer = 0
	local stormTimer = 0

	while true do
		task.wait(1)
		chaosTimer = chaosTimer + 1
		celestialTimer = celestialTimer + 1
		stormTimer = stormTimer + 1

		-- Evento Caos (5 min)
		if chaosTimer >= SETTINGS.CHAOS_INTERVAL then 
			chaosTimer = 0
			local e = math.random(1,3)
			if e == 1 then -- Gravedad
				eventMessage:FireAllClients("⚠ ¡FALLO GRAVEDAD! ⚠")
				workspace.Gravity = 30; task.wait(45); workspace.Gravity = 196.2
			elseif e == 2 then -- Velocidad
				eventMessage:FireAllClients("⚠ ¡SPEED RUN! ⚠")
				for _,p in ipairs(Players:GetPlayers()) do if p.Character then p.Character.Humanoid.WalkSpeed = 80 end end
				task.wait(30)
				for _,p in ipairs(Players:GetPlayers()) do if p.Character then p.Character.Humanoid.WalkSpeed = SETTINGS.PLAYER_SPEED end end
			elseif e == 3 then -- Yunque
				eventMessage:FireAllClients("⚠ ¡EL JUICIO DEL YUNQUE! ⚠")
				task.wait(4)
				local rich, maxC = nil, -1
				for _,p in ipairs(Players:GetPlayers()) do if p.leaderstats.Cash.Value > maxC then maxC = p.leaderstats.Cash.Value; rich = p end end
				if rich and rich.Character then
					local anvil = Instance.new("Part"); anvil.Size = Vector3.new(12,10,12); anvil.Color = Color3.new(0,0,0); anvil.Position = rich.Character.HumanoidRootPart.Position + Vector3.new(0,100,0)
					anvil.CustomPhysicalProperties = PhysicalProperties.new(100, 0, 0, 100, 100); anvil.Parent = workspace
					Debris:AddItem(anvil, 20)
				end
			end
		end

		-- Evento Celestial (5 min, desfasado)
		if celestialTimer >= (SETTINGS.CELESTIAL_INTERVAL - 20) then
			celestialTimer = 0
			local top, maxH = nil, -1
			for _,p in ipairs(Players:GetPlayers()) do local h = p:GetAttribute("MaxH") or 0; if h > maxH then maxH = h; top = p end end
			if top and maxH > 0 then
				if top.Character then local ff = Instance.new("ForceField", top.Character); Debris:AddItem(ff, 60) end
				eventMessage:FireAllClients("✨ TRIBUTO PARA "..top.Name.." ✨")
				local t = towersFolder:FindFirstChild("Tycoon_"..top.UserId)
				if t then 
					local ac = SpawnCube({Name="APEX", Value=1000, Price=0, Rarity="GOD", Color=Color3.new(1,1,1), Mat=Enum.Material.Neon})
					ac.Anchored=true; ac.Position = t.GridParts.Origin.Position + Vector3.new(0, maxH+10, 0); ac.Parent = t.Blocks
				end
			end
		end

		-- Evento Tormenta (15 min)
		if stormTimer >= 900 then
			stormTimer = 0
			local topGlobalCube, topGlobalY = nil, -1e9
			for _, tycoon in ipairs(towersFolder:GetChildren()) do
				local blks = tycoon:FindFirstChild("Blocks")
				if blks then
					for _, b in ipairs(blks:GetChildren()) do
						if b:IsA("Part") and b.Position.Y > topGlobalY then
							-- Solo Metales
							if b.Material == Enum.Material.Metal or b.Material == Enum.Material.DiamondPlate then
								topGlobalY = b.Position.Y; topGlobalCube = b
							end
						end
					end
				end
			end
			if topGlobalCube then
				local msg = Instance.new("Message", workspace); msg.Text = "⚡ RAYO DE ZEUS ⚡\nLa torre de metal más alta ha sido bendecida."; Debris:AddItem(msg, 10)
				local beam = Instance.new("Part", workspace); beam.Size = Vector3.new(2, 500, 2); beam.Position = topGlobalCube.Position + Vector3.new(0, 250, 0); beam.Anchored = true; beam.CanCollide = false; beam.Color = Color3.new(1,1,1); beam.Material = Enum.Material.Neon; Debris:AddItem(beam, 0.5)
				local oldVal = topGlobalCube:GetAttribute("Value") or 0
				topGlobalCube:SetAttribute("Value", oldVal * 8) -- Multiplicador x8
				topGlobalCube.Color = Color3.fromRGB(0, 255, 255)
			end
		end
	end
end)

-- === INICIALIZACIÓN ===
SetupPlots()

Players.PlayerAdded:Connect(function(p)
	local ls = Instance.new("Folder", p); ls.Name = "leaderstats"
	local cash = Instance.new("NumberValue", ls); cash.Name = "Cash"; cash.Value = 1200
	p:SetAttribute("Carrying", false); p:SetAttribute("Time", 0); p:SetAttribute("MaxH", 0)

	p.CharacterAdded:Connect(function(char)
		task.wait(0.5)
		local hum = char:WaitForChild("Humanoid")
		local hrp = char:WaitForChild("HumanoidRootPart")
		hum.WalkSpeed = SETTINGS.PLAYER_SPEED
		hum.Died:Connect(function() p:SetAttribute("Carrying", false) end)

		-- PLACAJE CON INMUNIDAD
		local tb = false
		hrp.Touched:Connect(function(hit)
			if tb then return end
			local enemy = hit.Parent; local ePlr = Players:GetPlayerFromCharacter(enemy)
			if ePlr and ePlr ~= p and hrp.AssemblyLinearVelocity.Magnitude > SETTINGS.TACKLE_SPEED_THRESHOLD and ePlr:GetAttribute("Carrying") then
				tb = true
				local cc = nil
				for _,c in ipairs(enemy:GetChildren()) do if c:FindFirstChild("CarryingWeld") then cc = c; break end end
				if cc then
					-- Si es Permablock, rebota y no lo suelta
					if cc:GetAttribute("IsPerma") then 
						tb = false; return 
					end

					cc:FindFirstChild("CarryingWeld"):Destroy()
					ePlr:SetAttribute("Carrying", false); cc.CanCollide = true; cc.Anchored = false; cc.Parent = globalCubes
					local force = (enemy.HumanoidRootPart.Position - hrp.Position).Unit
					cc:ApplyImpulse(force * 1500 + Vector3.new(0,800,0))
				end
				task.wait(3); tb = false
			end
		end)
	end)

	for _, plot in ipairs(plots) do 
		if not plot.Owner then 
			plot.Owner = p; plot.Model.Name = "Tycoon_"..p.UserId; plot.Model:SetAttribute("OwnerID", p.UserId) 
			break 
		end 
	end
end)

task.spawn(function() while true do task.wait(1.5) SpawnCube() end end)
